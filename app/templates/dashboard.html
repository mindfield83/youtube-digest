<!-- app/templates/dashboard.html -->
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - Dashboard</title>
    <link rel="stylesheet" href="/static/dashboard.css">
    <!-- Phosphor Icons -->
    <link rel="stylesheet" href="https://unpkg.com/@phosphor-icons/web@2.1.1/src/regular/style.css">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
</head>
<body>
    <header class="header">
        <div class="container">
            <h1>
                <img src="/static/youtube-logo.png" alt="YouTube" class="header-logo">
                <span>Digest</span>
            </h1>
            <span class="version">v{{ version }}</span>
        </div>
    </header>

    <main class="container">
        <!-- Status Cards -->
        <section class="status-section" hx-get="/api/status" hx-trigger="load, every 30s" hx-swap="innerHTML">
            <div class="loading">Status wird geladen...</div>
        </section>

        <!-- Actions -->
        <section class="actions-section">
            <h2>Aktionen</h2>
            <div class="actions-grid">
                <button
                    class="btn btn-primary"
                    id="digest-btn"
                    onclick="triggerDigest()"
                >
                    Digest jetzt erstellen
                </button>
                <button
                    class="btn btn-secondary"
                    hx-post="/api/channels/sync"
                    hx-swap="none"
                    hx-on::after-request="showToast('Kanäle & Videos werden synchronisiert...')"
                >
                    Kanäle & Videos laden
                </button>
                <button
                    class="btn btn-secondary"
                    hx-post="/api/test-email"
                    hx-swap="none"
                    hx-on::after-request="handleTestEmailResponse(event)"
                >
                    Test-E-Mail senden
                </button>
                <a href="/api/oauth/status" class="btn btn-outline" target="_blank">
                    OAuth-Status prüfen
                </a>
            </div>

            <!-- Inline Progress (under buttons) -->
            <div id="action-progress" class="action-progress" style="display: none;">
                <div class="action-progress__header">
                    <i class="ph ph-spinner action-progress__icon"></i>
                    <span class="action-progress__message">Initialisiere...</span>
                </div>
                <div class="action-progress__bar-container">
                    <div class="action-progress__bar" style="width: 0%;"></div>
                </div>
                <div class="action-progress__detail"></div>
            </div>
        </section>

        <!-- Progress Modal (fallback) -->
        <div id="progress-modal" class="modal" style="display: none;">
            <div class="modal-backdrop" onclick="closeProgressModal()"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Digest wird erstellt...</h3>
                    <button class="modal-close" onclick="closeProgressModal()">&times;</button>
                </div>
                <div class="modal-body" id="progress-container">
                    <div class="progress-content">
                        <div class="progress-icon">
                            <i class="ph-hourglass"></i>
                        </div>
                        <div class="progress-info">
                            <div class="progress-message">Initialisiere...</div>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: 0%;"></div>
                        </div>
                        <div class="progress-percent">0%</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <nav class="tabs">
            <button class="tab active" data-tab="videos">Videos</button>
            <button class="tab" data-tab="channels">Kanäle</button>
            <button class="tab" data-tab="digests">Digest-Verlauf</button>
        </nav>

        <!-- Videos Tab -->
        <section id="videos-tab" class="tab-content active">
            <div class="filters">
                <select id="category-filter" onchange="filterVideos()">
                    <option value="">Alle Kategorien</option>
                    <option value="Claude Code">Claude Code</option>
                    <option value="Coding/AI Allgemein">Coding/AI</option>
                    <option value="Brettspiele">Brettspiele</option>
                    <option value="Gesundheit">Gesundheit</option>
                    <option value="Sport">Sport</option>
                    <option value="Beziehung/Sexualität">Beziehung</option>
                    <option value="Beachvolleyball">Beachvolleyball</option>
                    <option value="Sonstige">Sonstige</option>
                </select>
                <select id="status-filter" onchange="filterVideos()">
                    <option value="">Alle Status</option>
                    <option value="pending">Ausstehend</option>
                    <option value="processing">In Bearbeitung</option>
                    <option value="completed">Abgeschlossen</option>
                    <option value="failed">Fehlgeschlagen</option>
                </select>
            </div>
            <div id="videos-list" hx-get="/api/videos" hx-trigger="load" hx-swap="innerHTML">
                <div class="loading">Videos werden geladen...</div>
            </div>
        </section>

        <!-- Channels Tab -->
        <section id="channels-tab" class="tab-content">
            <div id="channels-list" hx-get="/api/channels" hx-trigger="load" hx-swap="innerHTML">
                <div class="loading">Kanäle werden geladen...</div>
            </div>
        </section>

        <!-- Digests Tab -->
        <section id="digests-tab" class="tab-content">
            <div id="digests-list" hx-get="/api/digests" hx-trigger="load" hx-swap="innerHTML">
                <div class="loading">Digest-Verlauf wird geladen...</div>
            </div>
        </section>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2026 Mindfield Biosystems - YouTube Digest v{{ version }}</p>
        </div>
    </footer>

    <script>
        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                tab.classList.add('active');
                document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
            });
        });

        // Filter videos
        function filterVideos() {
            const category = document.getElementById('category-filter').value;
            const status = document.getElementById('status-filter').value;

            let url = '/api/videos?';
            if (category) url += `category=${encodeURIComponent(category)}&`;
            if (status) url += `status=${encodeURIComponent(status)}&`;

            htmx.ajax('GET', url, '#videos-list');
        }

        // Toast notifications
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Test email response handler
        function handleTestEmailResponse(event) {
            try {
                const response = JSON.parse(event.detail.xhr.responseText);
                if (response.success) {
                    showToast(response.message, 'success');
                } else {
                    showToast(response.message, 'error');
                }
            } catch (e) {
                showToast('Unbekannter Fehler', 'error');
            }
        }

        // Category change handler
        function handleCategoryChange(event) {
            try {
                const response = JSON.parse(event.detail.xhr.responseText);
                if (response.success) {
                    showToast(response.message, 'success');
                } else {
                    showToast(response.message || 'Kategorie-Änderung fehlgeschlagen', 'error');
                }
            } catch (e) {
                showToast('Fehler beim Setzen der Kategorie', 'error');
            }
        }

        // Resend digest handler
        function handleResendResponse(event) {
            try {
                const response = JSON.parse(event.detail.xhr.responseText);
                if (response.success) {
                    showToast(response.message, 'success');
                } else {
                    showToast(response.message || 'Erneutes Senden fehlgeschlagen', 'error');
                }
            } catch (e) {
                if (event.detail.xhr.status >= 400) {
                    showToast('Fehler beim erneuten Senden des Digests', 'error');
                } else {
                    showToast('Digest wird gesendet...', 'info');
                }
            }
        }

        // Progress tracking (inline under buttons)
        let progressPollingInterval = null;
        let currentTaskId = null;

        function showInlineProgress() {
            const container = document.getElementById('action-progress');
            container.style.display = 'block';
            // Disable digest button while running
            document.getElementById('digest-btn').disabled = true;
        }

        function hideInlineProgress() {
            const container = document.getElementById('action-progress');
            container.style.display = 'none';
            // Re-enable digest button
            document.getElementById('digest-btn').disabled = false;
            if (progressPollingInterval) {
                clearInterval(progressPollingInterval);
                progressPollingInterval = null;
            }
            currentTaskId = null;
        }

        async function triggerDigest() {
            try {
                const response = await fetch('/api/trigger-digest', { method: 'POST' });
                const data = await response.json();

                if (data.status === 'skipped') {
                    showToast(data.message, 'info');
                    return;
                }

                if (data.task_id) {
                    currentTaskId = data.task_id;
                    showInlineProgress();
                    startProgressPolling(data.task_id);
                }
            } catch (e) {
                showToast('Fehler beim Starten des Digests', 'error');
            }
        }

        function startProgressPolling(taskId) {
            // Initial fetch
            updateInlineProgress(taskId);

            // Poll every 2 seconds
            progressPollingInterval = setInterval(() => {
                updateInlineProgress(taskId);
            }, 2000);
        }

        async function updateInlineProgress(taskId) {
            try {
                const response = await fetch(`/api/tasks/${taskId}/progress`);
                const data = await response.json();

                const container = document.getElementById('action-progress');
                const messageEl = container.querySelector('.action-progress__message');
                const barEl = container.querySelector('.action-progress__bar');
                const detailEl = container.querySelector('.action-progress__detail');
                const iconEl = container.querySelector('.action-progress__icon');

                // Update message
                messageEl.textContent = data.message || 'Verarbeitung...';

                // Update progress bar
                barEl.style.width = `${data.percent || 0}%`;

                // Update detail (channel/video info)
                let detail = '';
                if (data.current_channel) {
                    detail = data.current_channel;
                    if (data.current_video_title) {
                        detail += ` - ${data.current_video_title}`;
                    }
                }
                detailEl.textContent = detail;

                // Update icon based on phase
                iconEl.className = 'ph action-progress__icon';
                if (data.phase === 'completed') {
                    iconEl.classList.add('ph-check-circle');
                    iconEl.style.color = '#22c55e';
                    iconEl.style.animation = 'none';
                } else if (data.phase === 'failed') {
                    iconEl.classList.add('ph-x-circle');
                    iconEl.style.color = '#ef4444';
                    iconEl.style.animation = 'none';
                } else {
                    iconEl.classList.add('ph-spinner');
                    iconEl.style.color = '';
                    iconEl.style.animation = '';
                }

                // Check for completion
                if (data.phase === 'completed' || data.phase === 'failed') {
                    if (progressPollingInterval) {
                        clearInterval(progressPollingInterval);
                        progressPollingInterval = null;
                    }

                    // Show toast and hide after delay
                    const toastType = data.phase === 'completed' ? 'success' : 'error';
                    showToast(data.message, toastType);

                    setTimeout(() => {
                        hideInlineProgress();
                        // Refresh status bar and videos list
                        htmx.ajax('GET', '/api/status', '.status-section');
                        htmx.ajax('GET', '/api/videos', '#videos-list');
                    }, 3000);
                }
            } catch (e) {
                console.error('Progress update failed:', e);
            }
        }

        // Legacy modal functions (kept for compatibility)
        function openProgressModal() {
            document.getElementById('progress-modal').style.display = 'flex';
        }

        function closeProgressModal() {
            document.getElementById('progress-modal').style.display = 'none';
            if (progressPollingInterval) {
                clearInterval(progressPollingInterval);
                progressPollingInterval = null;
            }
            currentTaskId = null;
        }
    </script>
</body>
</html>
